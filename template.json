{
  "variables": {
    "box_basename": "Archlinux-latest",
    "cloud_token": "{{ env `VAGRANT_CLOUD_TOKEN` }}",
    "vm_name": "archlinux-{{isotime \"2020.12.01-x86_64\"}}",
    "template": "ArchLinux_x64",
    "cpus": "2",
    "build_directory": "output",
    "disk_size": "80000",
    "http_directory": "http",
    "http_proxy": "{{env `http_proxy`}}",
    "https_proxy": "{{env `https_proxy`}}",
    "no_proxy": "{{env `no_proxy`}}",
    "headless": "false",
    "memory": "4096",
    "iso_url": "iso/archlinux-2020.12.01-x86_64.iso",
    "iso_checksum": "aea95a15c9f034d10e665247cfe782bccb5b306e",
    "ssh_timeout": "30m",
    "boot_wait": "10s",
    "country": "US",
    "write_zeros": "true"
  },
  "builders": [
    {
      "type": "virtualbox-iso",
      "boot_wait": "{{user `boot_wait`}}",
      "http_directory": "{{user `http_directory`}}",
      "disk_size": "{{user `disk_size`}}",
      "hard_drive_interface": "sata",
      "guest_os_type": "ArchLinux_64",
      "output_directory": "{{ user `build_directory` }}/packer-{{user `template`}}-virtualbox",
      "iso_checksum": "{{user `iso_checksum`}}",
      "iso_url": "{{user `iso_url`}}",
      "ssh_username": "vagrant",
      "ssh_password": "vagrant",
      "ssh_port": 22,
      "ssh_wait_timeout": "{{user `ssh_timeout`}}",
      "shutdown_command": "sudo systemctl start poweroff.timer",
      "guest_additions_mode": "disable",
      "headless": "{{ user `headless`}}",
      "vboxmanage": [
        [
          "modifyvm",
          "{{.Name}}",
          "--memory",
          "{{user `memory`}}"
        ],
        [
          "modifyvm",
          "{{.Name}}",
          "--cpus",
          "{{user `cpus`}}"
        ]
      ],
      "boot_command": [
        "<enter><wait10><wait10><wait10><wait10>",
        "/usr/bin/curl -O http://{{ .HTTPIP }}:{{ .HTTPPort }}/enable-ssh.sh<enter><wait5>",
        "/usr/bin/curl -O http://{{ .HTTPIP }}:{{ .HTTPPort }}/poweroff.timer<enter><wait5>",
        "/usr/bin/bash ./enable-ssh.sh<enter>"
      ]
    }
  ],
  "post-processors": [
    [
      {
        "output": "{{ user `build_directory` }}/{{user `box_basename`}}.{{.Provider}}.box",
        "type": "vagrant"
      },
      {
        "type": "vagrant-cloud",
        "box_tag": "ProfessorManhattan/Molecule-Archlinux-20.12.01",
        "access_token": "{{ user `cloud_token` }}",
        "version": "1.0.0"
      }
    ]
  ],
  "provisioners": [
    {
      "type": "shell",
      "execute_command": "{{ .Vars }} COUNTRY={{ user `country` }} sudo -E -S bash '{{ .Path }}'",
      "expect_disconnect": true,
      "script": "scripts/install-base.sh"
    },
    {
      "only": [
        "virtualbox-iso"
      ],
      "type": "shell",
      "execute_command": "{{ .Vars }} sudo -E -S bash '{{ .Path }}'",
      "script": "scripts/install-virtualbox.sh"
    },
    {
      "type": "shell",
      "execute_command": "{{ .Vars }} sudo -E -S bash '{{ .Path }}'",
      "script": "scripts/install-gdm-gnome.sh"
    },
    {
      "type": "shell",
      "execute_command": "{{ .Vars }} WRITE_ZEROS={{ user `write_zeros` }} sudo -E -S bash '{{ .Path }}'",
      "script": "scripts/cleanup.sh"
    }
  ]
}
